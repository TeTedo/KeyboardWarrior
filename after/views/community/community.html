<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <script
            src="https://kit.fontawesome.com/3264d39625.js"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"
        ></script>
        <!-- Tagify 해시태그 -->
        <script src="https://unpkg.com/@yaireo/tagify"></script>
        <script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
        <link
            href="https://unpkg.com/@yaireo/tagify/dist/tagify.css"
            rel="stylesheet"
            type="text/css"
        />
    </head>
    <link rel="stylesheet" href="style.css" />
    <body>
        <div id="mainPageTop">
            <div id="mainLogo"><a href="/">이건 메인로고</a></div>
            <ul id="mainPageNav">
                <li><a href="/community_hub">COMMUNITY</a></li>
                <li><a href="/minigame">MINI GAME</a></li>
            </ul>

            <ul id="mainPageLogo">
                <li>
                    <a href="https://github.com/TeTedo/KeyboardWarrior.git"
                        ><img
                            class="mainPageLogo_githubLogo"
                            src="http://rajlab.org/icons/github_white.png"
                            alt="github"
                    /></a>
                </li>
                <li>
                    <a
                        href="https://www.notion.so/Keyboard-Warrior-888a144aa79f437e8f726910c42617a8"
                        ><img
                            class="mainPageLogo_notionLogo"
                            src="https://upload.wikimedia.org/wikipedia/commons/4/45/Notion_app_logo.png"
                            alt="notion"
                    /></a>
                </li>
            </ul>
        </div>

        <!-- <div id="mainPageSearch">
      <div id="mainPageSearch_whole">
        <input type="text" id="mainPageSearch_searchBar" />
        <span>검색</span>
      </div>
    </div> -->
        <!-- 여기까지 탑 공통 부분 -->

        <!-- 사이드바 -->

        <div id="sideBar">
            <div id="sideBar_top">
                <div id="sideBar_top_up">
                    <ul>
                        <li>팔로워</li>
                        <li>123</li>
                    </ul>
                    <ul>
                        <li>팔로잉</li>
                        <li>111</li>
                    </ul>
                </div>
                <div id="sideBar_top_down">
                    <div id="sideBar_top_down_left">
                        <div><%= data.userIdForProfile %></div>
                        <div><%= data.nickNameForProfile %></div>
                    </div>
                    <div id="sideBar_top_down_right">
                        <div>
                            <a href=""><i class="fa-solid fa-bell"></i></a>
                            <a href=""><i class="fa-solid fa-comments"></i></a>
                            <a href="/logout"
                                ><i class="fa-solid fa-right-from-bracket"></i
                            ></a>
                        </div>
                        <a id="writBtn" href="#">글쓰기</a>
                        <a
                            id="closeBtn"
                            href="#"
                            onclick="{sideBar.style.display = 'none'}"
                            >버튼</a
                        >
                        <a id="modify" href="/join/modify/enterance"
                            >회원정보수정</a
                        >
                    </div>
                </div>
                <div id="sideBar_top_profileImg">
                    <img src="../<%= data.imageForProfile %>" alt="" />
                </div>
            </div>
        </div>

        <!-- 포스팅 시작 -->
        <div id="communityTitle">
            <div id="communityTitle_text">
                <span><%= data.title %></span>
            </div>
        </div>
        <div id="contents">
            <div id="contentsWrap">
                <div id="mainContent">
                    <div id="mainContentWrap">
                        <!-- <div class="mainPost">
                            <div id="mainPost_top">
                                <div id="mainPost_top_profileimg">
                                    <img
                                        src="../images/profileimg.jpg"
                                        alt=""
                                    />
                                </div>
                                <ul id="mainPost_top_button">
                                    <li>
                                        <i class="fa-solid fa-heart"></i
                                        ><i
                                            class="fa-solid fa-heart-circle-check"
                                        ></i>
                                    </li>
                                    <li>
                                        <i class="fa-solid fa-share-nodes"></i>
                                    </li>
                                </ul>
                            </div>
                            <div id="mainPost_middle">
                                <div id="mainPost_middle_img">
                                    <img src="../images/Example.jpeg" alt="" />
                                </div>
                                <div id="mainPost_middle_text"></div>
                            </div>
                            <ul id="mainPost_bottom">
                                <li id="mainPost_bottom_recomment">
                                    <span>아이디</span>
                                    <span>여기서부터 댓글</span>
                                </li>
                            </ul>
                        </div> -->
                        <!-- 포스팅 1개끝 -->
                        <% data.postData.forEach(post=>{%>

                        <div
                            class="mainPost"
                            data-hash_tag="<%= post.hashtag_values%>"
                            data-post_id="<%= post.id%>"
                        >
                            <div id="mainPost_top">
                                <div id="mainPost_top_profileimg">
                                    <img src="../<%= data.imageForProfile %>" />
                                    <div id="mainPost_top_userInfo">
                                        <div
                                            id="mainPost_top_userInfo_nickName"
                                        >
                                            <%=data.nickNameForProfile%>
                                        </div>
                                        <div id="mainPost_top_userInfo_follwer">
                                            팔로워숫자
                                        </div>
                                    </div>
                                    <div id="mainPost_top_follwingBtn">
                                        <i class="fa-solid fa-user-plus"></i>
                                        <i class="fa-solid fa-user-check"></i>
                                        <i class="fa-solid fa-message"></i>
                                        <a href="">수정하기</a>
                                    </div>
                                </div>
                            </div>
                            <div id="mainPost_middle"><%=post.text%></div>
                            <div id="mainPost_bottom">
                                <div id="hashTag">
                                    <span>#</span>
                                    <%post.hashtag_values.forEach(hashtag=>{%>
                                    <span id="hashTag_Wrap">
                                        <span
                                            class="hashTag_Box"
                                            onclick="update(this)"
                                        >
                                            <%=hashtag%>
                                        </span>
                                    </span>
                                    <%})%>
                                </div>
                                <div id="mainPost_bottom_createdTime">
                                    생성된 시간
                                </div>
                                <div id="mainPost_bottom_sub">
                                    <i class="fa-solid fa-heart"></i
                                    >좋아요갯수넣기
                                    <i class="fa-solid fa-comment"></i
                                    >댓글갯수넣기
                                </div>
                            </div>
                        </div>
                        <%})%>
                    </div>
                </div>
                <!-- 여기까지 메인포스팅 슬라이드 -->
                <div id="scrollHelper">
                    <div id="scrollHelper_contents">
                        <div id="scrollHelper_icon">➡️</div>
                        <div id="scrollHelper_text">SCROLL UP!</div>
                    </div>
                </div>
            </div>
        </div>
        <button id="btn" name="hash" style="right: 70%">클릭</button>
        <span id="searchBar">
            <label for="">검색</label>
            <input type="text" list="tag_list" id="searchBar_input" />
            <datalist id="tag_list">
                <!-- <option value="잡담"></option>
                <option value="거래"></option>
                <option value="공략"></option> -->
            </datalist>
        </span>
    </body>
    <script src="community.js"></script>
    <script>
        // 사이드바
        btn.onclick = () => {
            sideBar.style.display = "block";
        };

        // 글쓰기버튼
        const gameName = "<%= data.gameName %>";
        writBtn.onclick = () => {
            location.href = `/posting/${gameName}`;
        };

        // 포스트 클릭시 상세페이지 이동
        const mainPost = document.querySelectorAll(".mainPost");
        // const mainPost = Array.from(document.querySelectorAll(".mainPost"));
        mainPost.forEach(post => {
            const postId = post.dataset.post_id;
            post.querySelector("#mainPost_middle").onclick = () => {
                location.href = `/post/${gameName}/${postId}`;
            };
        });

        // 데이터 가공 및 초기화
        let postData;
        function uploadData() {
            postData = "<%=JSON.stringify(data.postData)%>"
                .replaceAll("&#34;", '"')
                .replaceAll("&lt;", "<")
                .replaceAll("&gt;", ">")
                .replaceAll('""', '"');
            postData = JSON.parse(postData);
        }
        uploadData();

        // 검색창 드롭리스트에 해시태그 추가
        let hashtagArr = [];
        postData.forEach(data => {
            data.hashtag_values.forEach(hashtag => {
                if (!hashtagArr.includes(hashtag)) {
                    hashtagArr.push(hashtag);
                }
            });
        });
        hashtagArr.forEach(hashtag => {
            tag_list.innerHTML += `<option value=${hashtag}></option>`;
        });

        // 검색기능
        function Debounce(func, wait = 20, immediate = true) {
            var timeout;
            return function () {
                var context = this,
                    args = arguments;
                var later = function () {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                var callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait); //얘가 시간지나면 timeout을 0(false)로 만들어줌
                if (callNow) func.apply(context, args);
            };
        }
        searchBar_input.addEventListener("input", Debounce(search, 100, false));
        function search(e) {
            const searchedValue = e.target.value;
            postData = postData.filter(post => {
                const postText = post.text;
                const joinedValue = post.hashtag_values.join(",");
                return (
                    post.text.includes(searchedValue) ||
                    joinedValue.includes(searchedValue)
                );
            });
            if (postData.length == 0) {
                mainContentWrap.innerHTML = `
                <div class="mainPost">
                    <div class="noSearchedPostCaution"> 검색결과 없음 </div>
                </div>
                `;
                uploadData();
                return;
            }
            let postHtml = "";
            postData.forEach(filteredPost => {
                let hashtagHtml = "";
                filteredPost.hashtag_values.forEach(hashtag => {
                    // 해시태그내에 검색된글자 배경색 변경
                    if (hashtag.includes(searchedValue)) {
                        const reg = new RegExp(searchedValue, "i");
                        hashtag = hashtag.replace(
                            reg,
                            `<span class="searched_character">${searchedValue}</span>`
                        );
                    }
                    hashtagHtml += `
                    <span id="hashTag_Wrap">
                                <span class="hashTag_Box" onclick="update(this)">
                                    ${hashtag}
                                </span>
                            </span>
                    `;
                });
                // 텍스트내에 검색된글자 배경색 변경
                if (filteredPost.text.includes(searchedValue)) {
                    const reg = new RegExp(searchedValue, "i");
                    filteredPost.text = filteredPost.text.replace(
                        reg,
                        `<span class="searched_character">${searchedValue}</span>`
                    );
                }
                postHtml += `
                <div
                    class="mainPost"
                    data-post_id=${filteredPost.id}
                >
                    <div id="mainPost_top">
                        <div id="mainPost_top_profileimg">
                            <img src="../${filteredPost.profile_img}" alt="프로필이미지공간" />
                        </div>      
                        <div id="mainPost_top_userInfo">
                            <div id="mainPost_top_userInfo_nickName">${filteredPost.nickName}</div>
                            <div id="mainPost_top_userInfo_follwer">팔로워숫자</div>
                        </div>
                        <div id="mainPost_top_follwingBtn">
                            <i class="fa-solid fa-user-plus"></i>
                            <i class="fa-solid fa-user-check"></i>
                            <i class="fa-solid fa-message"></i>
                            <a href="수정하기페이지경로넣기">수정하기</a>
                        </div>
                    </div>
                    <div id="mainPost_middle">${filteredPost.text}</div>
                    <div id="mainPost_bottom">
                        <span>#</span>
                        ${hashtagHtml}
                        <div id="mainPost_bottom_createdTime">${filteredPost.createdAt}</div>
                        <div id="mainPost_bottom_sub">
                            <i class="fa-solid fa-heart"></i>좋아요갯수
                            <i class="fa-solid fa-comment"></i>댓글갯수
                        </div>
                    </div>
                </div>
                `;
            });
            mainContentWrap.innerHTML = postHtml;
            uploadData();
        }

        // 해시태그 클릭시 필터 기능
        function update(target) {
            searchBar_input.value = "";
            let isFiltered = false;
            let selectedOne = target.innerText;
            if (!target.classList.contains("active")) {
                postData = postData.filter(post => {
                    return post.hashtag_values.includes(selectedOne);
                });
                isFiltered = true;
            }
            let postHtml = "";
            postData.forEach(filteredPost => {
                let hashtagHtml = "";
                filteredPost.hashtag_values.forEach(hashtag => {
                    hashtagHtml += `
                    <span id="hashTag_Wrap">
                                <span class="hashTag_Box" onclick="update(this)">
                                    ${hashtag}
                                </span>
                            </span>
                    `;
                });
                postHtml += `
                <div
                    class="mainPost"
                    data-post_id=${filteredPost.id}
                >
                    <div id="mainPost_top"></div>
                    <div id="mainPost_middle">${filteredPost.text}</div>
                    <div id="mainPost_bottom">
                        <div id="hashTag" >
                            <span>#</span>
                            ${hashtagHtml}
                        </div>
                    </div>
                </div>
                `;
            });
            mainContentWrap.innerHTML = postHtml;
            const hashTagBox = document.querySelectorAll(".hashTag_Box");
            // 선택된 해시태그 css효과
            if (isFiltered) {
                hashTagBox.forEach(box => {
                    if (box.innerText == selectedOne) {
                        box.classList.add("active");
                        box.parentNode.classList.add("active");
                    }
                });
            }

            // postData를 서버에서 받아온 데이터로 다시 초기화
            uploadData();
        }

        // 수정하기 버튼 생성
        const mainPostsArr = document.querySelectorAll(".mainPost");

        if ("<%= data.nickNameForProfile %>") {
        }
    </script>
    <!-- <script>
        const arr = ["happy", "hi"];
        const jsonArr = JSON.stringify(arr);
        const stringArr = '["happy", "hi"]';

        console.log(JSON.parse(jsonArr));
        console.log(JSON.parse(stringArr));
    </script> -->
</html>
